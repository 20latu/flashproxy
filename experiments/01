#!/bin/bash

# Get arguments
if [ $1 ]; then
    NUM_CLIENTS=$1
else
    NUM_CLIENTS=1
fi

# Go to flashproxy repo root dir
cd ..

# Create 1GB dump file
echo "creating dump file..."
rm dump
dd if=/dev/null of=dump bs=1G seek=1

# Start http server
echo "starting http server..."
thttpd -p 1080

# Start crossdomain policy server
echo "starting cross domain policy server..."
sudo ./crossdomaind.py &

# Start the facilitator
echo "starting facilitator..."
./facilitator.py 4701 -r 127.0.0.1:1080

# Start socat adapters
echo "starting socat adapters..."
i=1
until [ $i -gt $NUM_CLIENTS ]; do
    let local_port=2000+i
    let remote_port=9000+i
    socat TCP-LISTEN:${remote_port},reuseaddr,fork TCP-LISTEN:${local_port},reuseaddr &
    let i=i+1
done

# Start the flash proxy, client side
echo "starting flash proxy client side..."
i=1
until [ $i -gt $NUM_CLIENTS ]; do
    let local_port=9000+i
    firefox --remote "openURL(http://localhost:1080/swfcat.swf?local=127.0.0.1:${local_port}&client=1&facilitator=127.0.0.1:4701)"
    let i=i+1
    sleep 2
done

# Some connections take a long time to register with cirrus
sleep 15

# Start the flash proxy, server side
echo "starting flash proxy server side..."
firefox --remote "openURL(http://localhost:1080/swfcat.swf?facilitator=127.0.0.1:4701)"

sleep 15

let query_fac_time=NUM_CLIENTS+2
sleep ${query_fac_time}

# wget the dump file
echo "getting the dump file..."
i=2
until [ $i -gt $NUM_CLIENTS ]; do
    let local_port=2000+i
    gnome-terminal -e "/bin/bash -c 'wget -t1 http://localhost:${local_port}/dump -O - > /dev/null; exec /bin/bash -i'"
    let i=i+1
done

# Use this one for delaying the termination of experiment below
wget -t1 http://localhost:2001/dump -O - > /dev/null

# Slaughter the processes
sudo killall thttpd
ps -ef | sed -n '/crossdomaind.py/{/grep/!p;}' | awk '{print$2}' | sudo xargs -i kill {}
ps -ef | sed -n '/facilitator.py/{/grep/!p;}' | awk '{print$2}' | sudo xargs -i kill {}
sudo killall socat
